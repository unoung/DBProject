create or replace NONEDITIONABLE PACKAGE BODY PKG_RESERVATION_DETAIL AS
  PROCEDURE PROC_INS_RESERVATION_DETAIL
(
    IN_RM_ID      IN VARCHAR2,
    IN_R_ID        IN VARCHAR2,
    O_ERRCODE			OUT		VARCHAR2,
    O_ERRMSG			OUT		VARCHAR2
) AS
    V_NEW_RD_ID CHAR(5);
    V_CNT NUMBER(5);
    V_RM_ID_CNT NUMBER(5);
    V_GUBUN CHAR(1);
    V_DETAIL_RM_CNT NUMBER(5);
    RM_ID_EXCEPTION EXCEPTION;
    R_GUBUN_EXCEPTION EXCEPTION;
    
  BEGIN
      -- 예약관리 테이블에서 RM_ID가 있는지 확인
       SELECT COUNT(RM_ID)
       INTO V_RM_ID_CNT
       FROM RESERVATION_MANAGE_TBL
       WHERE RM_ID = IN_RM_ID;
       
        IF V_RM_ID_CNT = 0  THEN
             RAISE RM_ID_EXCEPTION;
        END IF;
        
         -- 예약관리 테이블에서 방을 예약 할수 있는지 확인
       SELECT RM_GUBUN
       INTO V_GUBUN
       FROM RESERVATION_MANAGE_TBL
       WHERE RM_ID = IN_RM_ID;
       
       IF V_GUBUN = 'X' THEN
            RAISE R_GUBUN_EXCEPTION;
       END IF;
       
        
        SELECT COUNT(RD_ID)
        INTO V_CNT
        FROM RESERVATION_DETAIL_TBL;
        
        IF V_CNT = 0 THEN
            INSERT INTO RESERVATION_DETAIL_TBL(RD_ID ,RM_ID,R_ID)
            VALUES('RD001',IN_RM_ID,IN_R_ID);
        ELSE
        
            SELECT 'RD' || TO_CHAR(TO_NUMBER(SUBSTR(MAX(RD_ID),3,3)) + 1,'FM000') 
            INTO V_NEW_RD_ID
            FROM RESERVATION_DETAIL_TBL;  
            
            INSERT INTO RESERVATION_DETAIL_TBL(RD_ID ,RM_ID,R_ID)
            VALUES(V_NEW_RD_ID,IN_RM_ID,IN_R_ID);
        
        END IF;
        
       EXCEPTION
       WHEN RM_ID_EXCEPTION THEN
       O_ERRCODE := 'ERROR-001';
       O_ERRMSG := '예약할 방이 없습니다.';
       
       WHEN R_GUBUN_EXCEPTION THEN
       O_ERRCODE := 'ERROR-002';
       O_ERRMSG := '예약할 수 없는 방입니다.';
       
       WHEN OTHERS THEN
       O_ERRCODE := SQLCODE;
       O_ERRMSG := SQLERRM;
       ROLLBACK;
        
        

        
  END PROC_INS_RESERVATION_DETAIL;

  PROCEDURE PROC_SEL_RESERVATION_DETAIL
(
    IN_RD_ID      IN VARCHAR2,
    IN_RM_ID      IN VARCHAR2,
    IN_R_ID        IN VARCHAR2,
    O_CUR         OUT    SYS_REFCURSOR
) AS
  BEGIN
        OPEN O_CUR FOR
        -- 예약 상세 데이터 조회 
		SELECT T1.RD_ID, T1.R_ID, T2.RM_ID, T2.ROOM_ID, T2.RM_DATE
				, T3.CUST_ID, DECODE(T4.GUBUN,'C','회원','비회원') AS 회원구분, T4.CUST_NAME, T4.CUST_TEL
				, T3.R_DATE, T3.R_PERSON, T3.R_PRICE
		FROM RESERVATION_DETAIL_TBL T1, RESERVATION_MANAGE_TBL T2, RESERVATION_TBL T3, CUSTOMER_TBL T4
		WHERE T1.RM_ID = T2.RM_ID
		AND T1.R_ID = T3.R_ID
		AND T3.CUST_ID = T4.CUST_ID
        AND T1.RD_ID LIKE '%' || IN_RD_ID  || '%'
        AND T2.RM_ID LIKE '%' || IN_RM_ID || '%'
        AND T1.R_ID LIKE '%' || IN_R_ID  || '%'
		ORDER BY T1.R_ID, T1.RM_ID
		;
  END PROC_SEL_RESERVATION_DETAIL;

  PROCEDURE PROC_UP_RESERVATION_MANAGE
(
	IN_RM_ID			IN VARCHAR2,
    IN_ROOM_ID		    IN VARCHAR2,
    IN_RM_DATE 		    IN DATE,
    IN_RM_GUBUN		    IN VARCHAR2,
    IN_RM_PRICE		    IN NUMBER,
    IN_RM_PERSON        IN NUMBER,
    IN_RM_ADD_PERSON  	IN NUMBER,
    IN_RM_ADD_PRICE     IN	NUMBER,
	
	O_ERRCODE			OUT		VARCHAR2,
    O_ERRMSG			OUT		VARCHAR2
) AS

		V_RM_ID_CNT		NUMBER(1);
		RM_ID_EXCEPTION	EXCEPTION;
	
  BEGIN
		
        UPDATE RESERVATION_MANAGE_TBL
        SET  ROOM_ID          =    IN_ROOM_ID,
              RM_DATE           =   IN_RM_DATE,
              RM_GUBUN         =    IN_RM_GUBUN,
              RM_PRICE            =   IN_RM_PRICE,
              RM_PERSON         =   IN_RM_PERSON ,
              RM_ADD_PERSON  =   IN_RM_ADD_PERSON,
              RM_ADD_PRICE     =   IN_RM_ADD_PRICE 
        WHERE RM_ID = IN_RM_ID;
	
  END PROC_UP_RESERVATION_MANAGE;
  PROCEDURE PROC_DEL_RESERVATION_DETAIL
(
    IN_RD_ID      IN VARCHAR2,
    IN_RM_ID      IN VARCHAR2,
    IN_R_ID        IN VARCHAR2
) AS
  BEGIN
    DELETE FROM RESERVATION_DETAIL_TBL
    WHERE RD_ID = IN_RD_ID;
  END PROC_DEL_RESERVATION_DETAIL;

END PKG_RESERVATION_DETAIL;